---
layout: page
title: Clustering lab
---

```{r options, echo=FALSE}
library(knitr)
opts_chunk$set(fig.path=paste0("figure/", sub("(.*).Rmd","\\1",basename(knitr:::knit_concord$get('infile'))), "-"))
```

## Clustering 

We will demonstrate the concepts and code needed to perform clusturing analysis with the tissue gene expression data:

```{r}
library(tissuesGeneExpression)
data(tissuesGeneExpression)
```

Now pretend that we don't know these are different tissues and are interested in clustering. The first step is to compute the distance between each sample:

```{r}
d <- dist( t(e) )
```

<a name="hierarchical"></a>

### Hierarchical Clustering

With the distance between each pari of samples computed, we need a clustering algorithms to join them into groups. Hierarchical clustering is one of the many clustering algorithms available to do this. The each sample is assigned to its own group and then the algorithm continues iteratively, joining the two most similar clusters at each step, and continuing until there is just one groups. Note that while we have defined distances between samples, we have not yet defined distances between groups. There are various ways this can be done and they all rely on the individual pairwise distances. The helpfile for `hclust` includes detailed informtion. 

We can perform hierarchical clustering based on the distances defined above, using the `hclust` function. This function returns an `hclust` object that describes the groupings that were created using the algorithm described above. The `plot` method represents these relationships with a tree or dendrogram: 

```{r}
library(rafalib)
mypar2(1,1)
hc <- hclust(d)
hc
plot(hc,labels=tissue)
```

Does this technique "discover" the clusters defined by the different tissues? In this case it is not easy to see the different tissues so we add colors by using the `mypclust` function from the `rafalib` package. 
 
```{r}
myplclust(hc, labels=tissue, lab.col=as.fumeric(tissue))
```

Keep in mind that hierarchical clustering does not define specific clusters, but rather defines the dendrogram above. From the dendogram we can decipher the distance between any two groups by looking at the height at which the two groups split into two. To define clusters we need to "cut the tree" at some distance  and group all samples that are within that distance into  groups below. To visualize this, we draw a horizontal line a the height we wish to cut and this defines the 
that line. We use 120 as an example:

```{r}
myplclust(hc, labels=tissue, lab.col=as.fumeric(tissue))
abline(h=120)
```

If we use the line above to cut the tree into clusters, we can examine how the clusters overlap with the actual tissues:

```{r}
hclusters <- cutree(hc, h=120)
table(true=tissue, cluster=hclusters)
```

<a name="kmeans"></a>

# K-means

We can also cluster with the `kmeans` function to perform k-means clustering. As an example, let's run k-means on the samples in the space of the first two genes:

```{r}
plot(e[1,], e[2,])
set.seed(1)
km <- kmeans(t(e[1:2,]), centers=7)
names(km)
plot(e[1,], e[2,], col=km$cluster, pch=16)
plot(e[1,], e[2,], col=as.fumeric(tissue), pch=16)
table(true=tissue,cluster=km$cluster)
```

We can instead perform k-means clustering using all of the genes. To visualize this, we can use an MDS plot:


```{r}
mds <- cmdscale(d)
plot(mds[,1], mds[,2]) 
km <- kmeans(t(e), centers=7)
plot(mds[,1], mds[,2], col=km$cluster, pch=16)
table(true=tissue,cluster=km$cluster)
```


<a name="heatmap"></a>

# Heatmaps

Heatmaps are useful plots for visualizing the measurements for a subset of rows over all the samples. A *dendrogram* is added on top and on the side is a hierarchical clustering as we saw before. First we will use the `heatmap` available in base R. Let's begin by defining a color palette:

```{r}
# install.packages("RColorBrewer")
library(RColorBrewer)
hmcol <- colorRampPalette(brewer.pal(9, "GnBu"))(100)
```

Now, pick the genes with the top variance over all samples:

```{r}
library(genefilter)
rv <- rowVars(e)
idx <- order(-rv)[1:40]
```

Now we can plot a heatmap of these genes:

```{r}
heatmap(e[idx,], col=hmcol)
```

The `heatmap.2` function in the `gplots` package on CRAN is a bit more
customized. For example, it stretches to fill the window. Here we add colors to indicate the tissue on the top:

```{r}
# install.packages("gplots")
library(gplots)
cols <- palette(brewer.pal(8, "Dark2"))[as.fumeric(tissue)]
head(cbind(colnames(e),cols))
heatmap.2(e[idx,], labCol=tissue,
          trace="none", 
          ColSideColors=cols, 
          col=hmcol)
```


